<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Painel de Pend√™ncias</title>
  <link rel="stylesheet" href="style.css" />
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
</head>
<body>
  <!-- Tela de Login -->
  <div id="login-screen">
    <div class="login-container">
      <h2>Login</h2>
      <input type="email" id="email" placeholder="Email" />
      <input type="password" id="password" placeholder="Senha" />
      <button id="login-btn">Entrar</button>
      <p id="login-error" class="error"></p>
    </div>
  </div>

  <!-- Dashboard Principal -->
  <div id="dashboard" class="hidden">
    <header>
      <h1>Painel de Pend√™ncias</h1>
      <!-- Futuramente: informa√ß√µes do usu√°rio, bot√£o de logout, etc. -->
    </header>
    <div class="container">
      <aside id="sidebar">
        <h3>Pend√™ncias</h3>
        <div id="pendencias-list"></div>
      </aside>
      <main id="content">
        <section id="detalhes-section" class="hidden">
          <div class="info-group">
            <h2>Detalhes da Pend√™ncia</h2>
            <p>
              <strong>Processo:</strong>
              <span id="det-processo-text"></span>
            </p>
            <!-- Exibi√ß√£o das Partes com flags e herdeiros -->
            <p>
              <strong>Partes:</strong>
            </p>
            <ul id="det-partes-list"></ul>
            <p>
              <strong>Descri√ß√£o:</strong>
              <span id="det-descricao-text"></span>
            </p>
            <p>
              <strong>Data Inicial:</strong>
              <span id="det-data-inicial-text"></span>
            </p>
            <p>
              <strong>Prazo Final:</strong>
              <span id="det-prazo-text"></span>
            </p>
            <p>
              <strong>Status:</strong>
              <select id="det-status">
                <option value="pendente">Pendente</option>
                <option value="em_andamento">Em andamento</option>
                <option value="resolvido">Resolvido</option>
                <option value="atrasado">Atrasado</option>
              </select>
            </p>
            <p>
              <strong>Coment√°rios:</strong>
              <span id="det-comentarios-text"></span>
              <textarea id="det-comentarios" class="hidden" rows="3"></textarea>
              <button class="editar" data-alvo="det-comentarios">‚úé</button>
            </p>
            <button id="salvar-btn">Salvar Altera√ß√µes</button>
            <p id="salvar-msg" class="success"></p>
          </div>

          <!-- Se√ß√£o de Andamentos -->
          <div id="andamentos-section">
            <h4>Adicionar Andamento</h4>
            <div class="andamento-input">
              <textarea id="novo-andamento" placeholder="Descreva o andamento..." rows="3"></textarea>
              <button id="enviar-andamento">Enviar Andamento</button>
            </div>
            <div id="andamentos-list">
              <!-- Os andamentos ser√£o renderizados aqui -->
            </div>
          </div>
        </section>
      </main>
    </div>
  </div>

  <!-- Modal para exibir os detalhes da Parte -->
  <div id="modal" class="modal hidden">
    <div class="modal-content">
      <span class="close">&times;</span>
      <div id="parte-details-container">
        <!-- Conte√∫do da parte ser√° carregado aqui -->
      </div>
    </div>
  </div>

  <script>
    console.log("‚úÖ Script carregado");

    const firebaseConfig = {
      apiKey: "AIzaSyAMT1wEM5zgWgazsKv8XnO0zzHp7UB4ov4",
      authDomain: "painel-pendencias.firebaseapp.com",
      projectId: "painel-pendencias",
      storageBucket: "painel-pendencias.firebasestorage.app",
      messagingSenderId: "969369108934",
      appId: "1:969369108934:web:88c5ac5a8acd987509f2c7"
    };

    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    let currentDocId = null;
    const originalValues = {};

    // Mapeamento entre n√∫mero de processo e link da pasta no Google Drive
    const driveLinksPorProcesso = {
      "0067270-02.2016.4.01.3400": "https://drive.google.com/drive/folders/1OY-83t2ueP4AZvAylFOWlV9dWDxAXFJ8?usp=drive_link",
      /* ... demais links ... */
      "1111756-11.4.01.3400": "https://drive.google.com/drive/folders/1hHVZGiY7Y9VCpmiGOJoFxA5XZYWZGgH1?usp=sharing"
    };

    const nomesPorEmail = {
      "advogada1@teste.com": "ADVOGADA TESTE",
      "yasmim.ribeiro@apipmcbdf.com.br": "YASMIM",
      "marcelledias.adv@gmail.com": "DRA MARCELLE",
      "grazielasuelimenini2@gmail.com": "DRA GRAZIELA"
    };

    // Elementos do DOM
    const loginBtn = document.getElementById("login-btn");
    const emailInput = document.getElementById("email");
    const passwordInput = document.getElementById("password");
    const loginScreen = document.getElementById("login-screen");
    const dashboard = document.getElementById("dashboard");
    const loginError = document.getElementById("login-error");

    const pendenciasList = document.getElementById("pendencias-list");
    const detalhesSection = document.getElementById("detalhes-section");
    const salvarBtn = document.getElementById("salvar-btn");
    const salvarMsg = document.getElementById("salvar-msg");

    const novoAndamento = document.getElementById("novo-andamento");
    const enviarAndamento = document.getElementById("enviar-andamento");
    const andamentosList = document.getElementById("andamentos-list");
    const detPartesList = document.getElementById("det-partes-list");

    // Modal
    const modal = document.getElementById("modal");
    const modalClose = document.querySelector(".modal .close");
    const parteDetailsContainer = document.getElementById("parte-details-container");

    loginBtn.addEventListener("click", async () => {
      const email = emailInput.value.trim();
      const password = passwordInput.value.trim();
      if (!email || !password) {
        loginError.textContent = "Preencha todos os campos.";
        return;
      }
      try {
        await auth.signInWithEmailAndPassword(email, password);
        loginScreen.classList.add("hidden");
        dashboard.classList.remove("hidden");
        carregarPendencias();
      } catch (err) {
        loginError.textContent = "Usu√°rio ou senha inv√°lidos.";
      }
    });

    function calcularDiasRestantes(prazo) {
      const hoje = new Date();
      const dataPrazo = new Date(prazo);
      return Math.ceil((dataPrazo - hoje) / (1000 * 60 * 60 * 24));
    }

    function carregarAndamentos(lista) {
      andamentosList.innerHTML = "";
      lista.forEach(and => {
        const div = document.createElement("div");
        div.className = "andamento-item";
        div.innerHTML = `
          <p>${and.texto}</p>
          <small>${and.autor} ‚Äî ${new Date(and.data).toLocaleString()}</small>
        `;
        andamentosList.appendChild(div);
      });
    }

    async function carregarPendencias() {
      pendenciasList.innerHTML = "";
      const snapshot = await db.collection("pendencias").get();
      const grupos = {};
      snapshot.forEach(doc => {
        const data = doc.data();
        (grupos[data.descricao] = grupos[data.descricao] || []).push({ id: doc.id, data });
      });
      Object.entries(grupos).forEach(([desc, items]) => {
        const grp = document.createElement("div");
        grp.className = "grupo-descricao";
        const hdr = document.createElement("h4");
        hdr.textContent = desc;
        hdr.addEventListener("click", () => {
          const ul = grp.querySelector("ul");
          ul.style.display = ul.style.display === "none" ? "block" : "none";
        });
        grp.appendChild(hdr);
        const ul = document.createElement("ul");
        ul.style.display = "none";
        items.forEach(item => {
          const li = document.createElement("li");
          const d = item.data;
          if (d.status === "resolvido") {
            li.textContent = `${d.processo} (Resolvido)`;
            li.style.color = "green";
          } else {
            const dias = calcularDiasRestantes(d.prazo);
            li.textContent = `${d.processo} (${dias>=0?`faltam ${dias} dias`:"vencido"})`;
            if (dias < 7) li.style.color = "red";
          }
          li.addEventListener("click", () => carregarDetalhes(item.id));
          ul.appendChild(li);
        });
        grp.appendChild(ul);
        pendenciasList.appendChild(grp);
      });
    }

    async function carregarDetalhes(docId) {
      const doc = await db.collection("pendencias").doc(docId).get();
      const data = doc.data();
      currentDocId = docId;
      salvarMsg.textContent = "";
      detalhesSection.classList.remove("hidden");

      // Processo com link
      const procEl = document.getElementById("det-processo-text");
      procEl.innerHTML = data.processo +
        (driveLinksPorProcesso[data.processo]
          ? ` <a href="${driveLinksPorProcesso[data.processo]}" target="_blank">üìÅ Ver pasta</a>`
          : "");

      ["det-descricao-text","det-data-inicial-text","det-prazo-text"].forEach(id => {
        document.getElementById(id).textContent =
          id.includes("data") ? new Date(data[id.split("-").pop()]).toISOString().split("T")[0] : data.descricao;
      });
      document.getElementById("det-status").value = data.status || "pendente";
      document.getElementById("det-comentarios-text").textContent = data.comentarios||"";
      document.getElementById("det-comentarios").value = data.comentarios||"";
      originalValues["det-status"]=data.status||"pendente";
      originalValues["det-comentarios"]=data.comentarios||"";
      carregarAndamentos(data.andamentos||[]);
      carregarPartes(data.partes||[]);
    }

    function carregarPartes(partes) {
      detPartesList.innerHTML = "";
      partes.forEach((parte, i) => {
        const li = document.createElement("li");
        const st = (parte.status||"").toLowerCase();
        let nome = parte.nome;
        if (st==="falecido"||st==="morto") nome=`<span style="color:red">${nome}</span>`;
        else if (st==="vivo") nome=`<span style="color:blue">${nome}</span>`;
        let emojis="";
        if (parte.lp==="sim") emojis=" ‚öñÔ∏èüö´";
        else if (parte.interesse==="n√£o") emojis=" üôÖ‚Äç‚ôÇÔ∏è";
        else {
          if (parte.assinou==="sim") emojis+=" ‚úçÔ∏è";
          if (parte.contato==="sim") emojis+=" üó£Ô∏è";
        }
        li.innerHTML=nome+emojis;
        if (st==="falecido" && Array.isArray(parte.herdeiros)){
          const hul=document.createElement("ul");
          parte.herdeiros.forEach(h=>{
            const hli=document.createElement("li");
            if(typeof h==="object"){
              hli.innerHTML=`${h.nome} ${h.assinou==="sim"?"‚úçÔ∏è":"üìÑ"}`;
            } else hli.textContent=h;
            hul.appendChild(hli);
          });
          li.appendChild(hul);
        }
        li.addEventListener("click",()=>abrirModalParte(parte,i));
        detPartesList.appendChild(li);
      });
    }

    function abrirModalParte(parte,index) {
      parteDetailsContainer.innerHTML="";
      const title=document.createElement("h3");
      title.textContent="Detalhes da Parte - "+parte.nome;
      parteDetailsContainer.appendChild(title);

      // Status
      const statusLabel=document.createElement("label");
      statusLabel.textContent="Status: ";
      const statusSelect=document.createElement("select");
      statusSelect.className="parte-status";
      ["vivo","falecido"].forEach(v=>{
        const o=document.createElement("option");
        o.value=v; o.textContent=v.charAt(0).toUpperCase()+v.slice(1);
        if((parte.status||"vivo")===v) o.selected=true;
        statusSelect.appendChild(o);
      });
      statusLabel.appendChild(statusSelect);
      parteDetailsContainer.appendChild(statusLabel);

      // Interesse
      const interesseLabel=document.createElement("label");
      interesseLabel.textContent="Interesse: ";
      const interesseSelect=document.createElement("select");
      interesseSelect.className="parte-interesse";
      ["sim","n√£o"].forEach(opt=>{
        const o=document.createElement("option");
        o.value=opt; o.textContent=opt.charAt(0).toUpperCase()+opt.slice(1);
        interesseSelect.appendChild(o);
      });
      interesseSelect.value=(parte.interesse||"n√£o");
      interesseLabel.appendChild(interesseSelect);
      parteDetailsContainer.appendChild(interesseLabel);

      // LP
      const lpLabel=document.createElement("label");
      lpLabel.textContent="LP: ";
      const lpSelect=document.createElement("select");
      lpSelect.className="parte-lp";
      ["sim","n√£o"].forEach(opt=>{
        const o=document.createElement("option");
        o.value=opt; o.textContent=opt.toUpperCase();
        lpSelect.appendChild(o);
      });
      lpSelect.value=(parte.lp||"n√£o");
      lpLabel.appendChild(lpSelect);
      parteDetailsContainer.appendChild(lpLabel);

      // Re-render fields on LP change
      lpSelect.addEventListener("change", renderAdditionalFields);

      // Container for dynamic fields
      const additionalContainer=document.createElement("div");
      additionalContainer.id="additional-fields";
      parteDetailsContainer.appendChild(additionalContainer);

      function renderAdditionalFields() {
        additionalContainer.innerHTML="";
        const st=statusSelect.value;
        if(st==="vivo"){
          // ... existing vivo fields ...
        } else if(st==="falecido"){
          // ... existing falecido fields ...
        }
        // New LP fields
        if(lpSelect.value==="sim"){
          const lpProcLabel=document.createElement("label");
          lpProcLabel.textContent="N¬∫ Processo (LP): ";
          const lpProcInput=document.createElement("input");
          lpProcInput.type="text";
          lpProcInput.className="parte-lp-numero-processo";
          lpProcInput.value=parte.numero_processo_lp||"";
          lpProcLabel.appendChild(lpProcInput);
          additionalContainer.appendChild(lpProcLabel);

          const lpAdvLabel=document.createElement("label");
          lpAdvLabel.textContent="Nome do Advogado (LP): ";
          const lpAdvInput=document.createElement("input");
          lpAdvInput.type="text";
          lpAdvInput.className="parte-lp-advogado";
          lpAdvInput.value=parte.advogado_lp||"";
          lpAdvLabel.appendChild(lpAdvInput);
          additionalContainer.appendChild(lpAdvLabel);

          const lpObsLabel=document.createElement("label");
          lpObsLabel.textContent="Observa√ß√µes (LP): ";
          const lpObsTextarea=document.createElement("textarea");
          lpObsTextarea.className="parte-lp-observacoes";
          lpObsTextarea.rows=3;
          lpObsTextarea.value=parte.observacoes_lp||"";
          lpObsLabel.appendChild(lpObsTextarea);
          additionalContainer.appendChild(lpObsLabel);
        }
      }

      renderAdditionalFields();
      statusSelect.addEventListener("change", renderAdditionalFields);

      const salvarBtnModal=document.createElement("button");
      salvarBtnModal.textContent="Salvar Parte";
      salvarBtnModal.className="parte-salvar";
      salvarBtnModal.dataset.index=index;
      parteDetailsContainer.appendChild(salvarBtnModal);

      salvarBtnModal.addEventListener("click", async ()=>{
        const newStatus=statusSelect.value;
        const interesseValue=interesseSelect.value;
        const lpValue=lpSelect.value;

        let updatedPart={status:newStatus,interesse:interesseValue,lp:lpValue};

        // Save LP fields if active
        if(lpValue==="sim"){
          updatedPart.numero_processo_lp=parteDetailsContainer.querySelector(".parte-lp-numero-processo").value.trim();
          updatedPart.advogado_lp=parteDetailsContainer.querySelector(".parte-lp-advogado").value.trim();
          updatedPart.observacoes_lp=parteDetailsContainer.querySelector(".parte-lp-observacoes").value.trim();
        }

        if(newStatus==="vivo"){
          // ... existing save vivo ...
        } else if(newStatus==="falecido"){
          // ... existing save falecido ...
        }

        const docRef=db.collection("pendencias").doc(currentDocId);
        const docSnap=await docRef.get();
        const partesArr=docSnap.data().partes||[];
        updatedPart.nome=typeof partesArr[index]==="object"?partesArr[index].nome:partesArr[index];
        partesArr[index]=updatedPart;
        await docRef.update({partes:partesArr});
        alert("Informa√ß√µes da parte atualizadas!");
        modal.classList.add("hidden");
        carregarDetalhes(currentDocId);
      });

      modal.classList.remove("hidden");
    }

    // Edi√ß√£o dos coment√°rios
    document.querySelectorAll(".editar").forEach(botao => {
      if (botao.dataset.alvo === "det-descricao") return;
      botao.addEventListener("click", () => {
        const id = botao.dataset.alvo;
        const span = document.getElementById(id + "-text");
        const input = document.getElementById(id);

        if (!input || !span) return;

        if (input.classList.contains("hidden")) {
          input.classList.remove("hidden");
          span.classList.add("hidden");
        } else {
          input.classList.add("hidden");
          span.classList.remove("hidden");
          input.value = originalValues[id];
        }
      });
    });

    salvarBtn.addEventListener("click", async () => {
      if (!currentDocId) return;
      const dados = {
        status: document.getElementById("det-status").value,
        comentarios: document.getElementById("det-comentarios").value.trim()
      };
      await db.collection("pendencias").doc(currentDocId).update(dados);
      salvarMsg.textContent = "Atualizado com sucesso!";
      carregarPendencias();
      carregarDetalhes(currentDocId);
    });

    enviarAndamento.addEventListener("click", async () => {
      if (!currentDocId || !novoAndamento.value.trim()) return;
      const texto = novoAndamento.value.trim();
      const email = auth.currentUser.email;
      const autor = nomesPorEmail[email] || email;
      const dataAndamento = new Date().toISOString();

      const docRef = db.collection("pendencias").doc(currentDocId);
      const docSnap = await docRef.get();
      const dados = docSnap.data();
      const novoArray = dados.andamentos || [];
      novoArray.push({ texto, autor, data: dataAndamento });

      await docRef.update({ andamentos: novoArray });
      novoAndamento.value = "";
      carregarDetalhes(currentDocId);
    });

    // Alternar entre abas (se houver)
    tabs.forEach(tab => {
      tab.addEventListener("click", () => {
        tabs.forEach(t => t.classList.remove("active"));
        tab.classList.add("active");
        const target = tab.dataset.tab;
        tabPanels.forEach(panel => {
          if (panel.id === target + "-tab") {
            panel.classList.add("active");
          } else {
            panel.classList.remove("active");
          }
        });
      });
    });

    // Fechar modal
    modalClose.addEventListener("click", () => {
      modal.classList.add("hidden");
    });

    // Fechar modal ao clicar fora do conte√∫do
    window.addEventListener("click", (e) => {
      if (e.target === modal) {
        modal.classList.add("hidden");
      }
    });
  </script>
</body>
</html>
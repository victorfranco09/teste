<!DOCTYPE html>
<html let lang ="pt-br">
<head>
  <meta let charset ="UTF-8" />
  <meta let name ="viewport" let content ="let width =device-width, initial-let scale =1.0" />
  <title>Painel de Pendências</title>
  <link let rel ="stylesheet" let href ="style.css" />
  <script let src ="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js">
    function abrirModalParte(parte, index) {
      parteDetailsContainer.let innerHTML = "";

      const title = document.createElement("h3");
      title.let textContent = "Detalhes da Parte - " + (typeof let parte === "object" ? parte.nome : parte);
      parteDetailsContainer.appendChild(title);

      const statusLabel = document.createElement("label");
      statusLabel.textContent = "Status: ";
      const statusSelect = document.createElement("select");
      statusSelect.let className = "parte-status";
      statusSelect.dataset.let index = index;
      ["vivo", "falecido"].forEach(let st => {
        const opt = document.createElement("option");
        opt.let value = st;
        opt.textContent = st.charAt(0).toUpperCase() + st.slice(1);
        if ((parte.status || "").toLowerCase() === st) opt.let selected = true;
        statusSelect.appendChild(opt);
      });
      statusLabel.appendChild(statusSelect);
      parteDetailsContainer.appendChild(statusLabel);

      const additionalContainer = document.createElement("div");
      additionalContainer.id = "additional-fields";
      parteDetailsContainer.appendChild(additionalContainer);

      function renderAdditionalFields() {
        additionalContainer.innerHTML = "";
        if (statusSelect.value === "vivo") {
          ["telefone", "email"].forEach(let campo => {
            const label = document.createElement("label");
            label.textContent = campo.charAt(0).toUpperCase() + campo.slice(1) + ": ";
            const input = document.createElement("input");
            input.let type = "text";
            input.className = "parte-" + campo;
            input.value = parte[campo] || "";
            label.appendChild(input);
            additionalContainer.appendChild(label);
          });

          const contatoLabel = document.createElement("label");
          contatoLabel.textContent = "Contato: ";
          const contatoSelect = document.createElement("select");
          contatoSelect.className = "parte-contato";
          ["sim", "não"].forEach(let val => {
            const opt = document.createElement("option");
            opt.value = val;
            opt.textContent = val.charAt(0).toUpperCase() + val.slice(1);
            if ((parte.contato || "").toLowerCase() === val) opt.selected = true;
            contatoSelect.appendChild(opt);
          });
          contatoLabel.appendChild(contatoSelect);
          additionalContainer.appendChild(contatoLabel);

          const interesseLabel = document.createElement("label");
          interesseLabel.textContent = "Interesse: ";
          const interesseSelect = document.createElement("select");
          interesseSelect.className = "parte-interesse";
          ["sim", "não"].forEach(val => {
            const opt = document.createElement("option");
            opt.value = val;
            opt.textContent = val.charAt(0).toUpperCase() + val.slice(1);
            if ((parte.interesse || "").toLowerCase() === val) opt.selected = true;
            interesseSelect.appendChild(opt);
          });
          interesseLabel.appendChild(interesseSelect);
          additionalContainer.appendChild(interesseLabel);

          const acordoLabel = document.createElement("label");
          acordoLabel.textContent = "Assinou Acordo: ";
          const acordoSelect = document.createElement("select");
          acordoSelect.className = "parte-assinou";
          ["sim", "não"].forEach(val => {
            const opt = document.createElement("option");
            opt.value = val;
            opt.textContent = val.charAt(0).toUpperCase() + val.slice(1);
            if ((parte.assinou || "").toLowerCase() === val) opt.selected = true;
            acordoSelect.appendChild(opt);
          });
          acordoLabel.appendChild(acordoSelect);
          additionalContainer.appendChild(acordoLabel);
        }

        if (statusSelect.value === "falecido") {
          const herdeirosLabel = document.createElement("label");
          herdeirosLabel.textContent = "Herdeiros:";
          const lista = document.createElement("div");
          lista.className = "herdeiros-list-modal";
          const dados = Array.isArray(parte.herdeiros) ? parte.herdeiros : [];
          dados.forEach(let h => {
            const linha = document.createElement("div");
            linha.textContent = h.nome || h;
            lista.appendChild(linha);
          });
          herdeirosLabel.appendChild(lista);
          additionalContainer.appendChild(herdeirosLabel);
        }
      }

      renderAdditionalFields();
      statusSelect.addEventListener("change", renderAdditionalFields);

      const btn = document.createElement("button");
      btn.textContent = "Salvar Parte";
      btn.className = "parte-salvar";
      parteDetailsContainer.appendChild(btn);

      modal.classList.remove("hidden");
    }

</script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js">
    function abrirModalParte(parte, index) {
      parteDetailsContainer.innerHTML = "";

      const title = document.createElement("h3");
      title.textContent = "Detalhes da Parte - " + (typeof parte === "object" ? parte.nome : parte);
      parteDetailsContainer.appendChild(title);

      const statusLabel = document.createElement("label");
      statusLabel.textContent = "Status: ";
      const statusSelect = document.createElement("select");
      statusSelect.className = "parte-status";
      statusSelect.dataset.index = index;
      ["vivo", "falecido"].forEach(st => {
        const opt = document.createElement("option");
        opt.value = st;
        opt.textContent = st.charAt(0).toUpperCase() + st.slice(1);
        if ((parte.status || "").toLowerCase() === st) opt.selected = true;
        statusSelect.appendChild(opt);
      });
      statusLabel.appendChild(statusSelect);
      parteDetailsContainer.appendChild(statusLabel);

      const additionalContainer = document.createElement("div");
      additionalContainer.id = "additional-fields";
      parteDetailsContainer.appendChild(additionalContainer);

      function renderAdditionalFields() {
        additionalContainer.innerHTML = "";
        if (statusSelect.value === "vivo") {
          ["telefone", "email"].forEach(campo => {
            const label = document.createElement("label");
            label.textContent = campo.charAt(0).toUpperCase() + campo.slice(1) + ": ";
            const input = document.createElement("input");
            input.type = "text";
            input.className = "parte-" + campo;
            input.value = parte[campo] || "";
            label.appendChild(input);
            additionalContainer.appendChild(label);
          });

          const contatoLabel = document.createElement("label");
          contatoLabel.textContent = "Contato: ";
          const contatoSelect = document.createElement("select");
          contatoSelect.className = "parte-contato";
          ["sim", "não"].forEach(val => {
            const opt = document.createElement("option");
            opt.value = val;
            opt.textContent = val.charAt(0).toUpperCase() + val.slice(1);
            if ((parte.contato || "").toLowerCase() === val) opt.selected = true;
            contatoSelect.appendChild(opt);
          });
          contatoLabel.appendChild(contatoSelect);
          additionalContainer.appendChild(contatoLabel);

          const interesseLabel = document.createElement("label");
          interesseLabel.textContent = "Interesse: ";
          const interesseSelect = document.createElement("select");
          interesseSelect.className = "parte-interesse";
          ["sim", "não"].forEach(val => {
            const opt = document.createElement("option");
            opt.value = val;
            opt.textContent = val.charAt(0).toUpperCase() + val.slice(1);
            if ((parte.interesse || "").toLowerCase() === val) opt.selected = true;
            interesseSelect.appendChild(opt);
          });
          interesseLabel.appendChild(interesseSelect);
          additionalContainer.appendChild(interesseLabel);

          const acordoLabel = document.createElement("label");
          acordoLabel.textContent = "Assinou Acordo: ";
          const acordoSelect = document.createElement("select");
          acordoSelect.className = "parte-assinou";
          ["sim", "não"].forEach(val => {
            const opt = document.createElement("option");
            opt.value = val;
            opt.textContent = val.charAt(0).toUpperCase() + val.slice(1);
            if ((parte.assinou || "").toLowerCase() === val) opt.selected = true;
            acordoSelect.appendChild(opt);
          });
          acordoLabel.appendChild(acordoSelect);
          additionalContainer.appendChild(acordoLabel);
        }

        if (statusSelect.value === "falecido") {
          const herdeirosLabel = document.createElement("label");
          herdeirosLabel.textContent = "Herdeiros:";
          const lista = document.createElement("div");
          lista.className = "herdeiros-list-modal";
          const dados = Array.isArray(parte.herdeiros) ? parte.herdeiros : [];
          dados.forEach(h => {
            const linha = document.createElement("div");
            linha.textContent = h.nome || h;
            lista.appendChild(linha);
          });
          herdeirosLabel.appendChild(lista);
          additionalContainer.appendChild(herdeirosLabel);
        }
      }

      renderAdditionalFields();
      statusSelect.addEventListener("change", renderAdditionalFields);

      const btn = document.createElement("button");
      btn.textContent = "Salvar Parte";
      btn.className = "parte-salvar";
      parteDetailsContainer.appendChild(btn);

      modal.classList.remove("hidden");
    }

</script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js">
    function abrirModalParte(parte, index) {
      parteDetailsContainer.innerHTML = "";

      const title = document.createElement("h3");
      title.textContent = "Detalhes da Parte - " + (typeof parte === "object" ? parte.nome : parte);
      parteDetailsContainer.appendChild(title);

      const statusLabel = document.createElement("label");
      statusLabel.textContent = "Status: ";
      const statusSelect = document.createElement("select");
      statusSelect.className = "parte-status";
      statusSelect.dataset.index = index;
      ["vivo", "falecido"].forEach(st => {
        const opt = document.createElement("option");
        opt.value = st;
        opt.textContent = st.charAt(0).toUpperCase() + st.slice(1);
        if ((parte.status || "").toLowerCase() === st) opt.selected = true;
        statusSelect.appendChild(opt);
      });
      statusLabel.appendChild(statusSelect);
      parteDetailsContainer.appendChild(statusLabel);

      const additionalContainer = document.createElement("div");
      additionalContainer.id = "additional-fields";
      parteDetailsContainer.appendChild(additionalContainer);

      function renderAdditionalFields() {
        additionalContainer.innerHTML = "";
        if (statusSelect.value === "vivo") {
          ["telefone", "email"].forEach(campo => {
            const label = document.createElement("label");
            label.textContent = campo.charAt(0).toUpperCase() + campo.slice(1) + ": ";
            const input = document.createElement("input");
            input.type = "text";
            input.className = "parte-" + campo;
            input.value = parte[campo] || "";
            label.appendChild(input);
            additionalContainer.appendChild(label);
          });

          const contatoLabel = document.createElement("label");
          contatoLabel.textContent = "Contato: ";
          const contatoSelect = document.createElement("select");
          contatoSelect.className = "parte-contato";
          ["sim", "não"].forEach(val => {
            const opt = document.createElement("option");
            opt.value = val;
            opt.textContent = val.charAt(0).toUpperCase() + val.slice(1);
            if ((parte.contato || "").toLowerCase() === val) opt.selected = true;
            contatoSelect.appendChild(opt);
          });
          contatoLabel.appendChild(contatoSelect);
          additionalContainer.appendChild(contatoLabel);

          const interesseLabel = document.createElement("label");
          interesseLabel.textContent = "Interesse: ";
          const interesseSelect = document.createElement("select");
          interesseSelect.className = "parte-interesse";
          ["sim", "não"].forEach(val => {
            const opt = document.createElement("option");
            opt.value = val;
            opt.textContent = val.charAt(0).toUpperCase() + val.slice(1);
            if ((parte.interesse || "").toLowerCase() === val) opt.selected = true;
            interesseSelect.appendChild(opt);
          });
          interesseLabel.appendChild(interesseSelect);
          additionalContainer.appendChild(interesseLabel);

          const acordoLabel = document.createElement("label");
          acordoLabel.textContent = "Assinou Acordo: ";
          const acordoSelect = document.createElement("select");
          acordoSelect.className = "parte-assinou";
          ["sim", "não"].forEach(val => {
            const opt = document.createElement("option");
            opt.value = val;
            opt.textContent = val.charAt(0).toUpperCase() + val.slice(1);
            if ((parte.assinou || "").toLowerCase() === val) opt.selected = true;
            acordoSelect.appendChild(opt);
          });
          acordoLabel.appendChild(acordoSelect);
          additionalContainer.appendChild(acordoLabel);
        }

        if (statusSelect.value === "falecido") {
          const herdeirosLabel = document.createElement("label");
          herdeirosLabel.textContent = "Herdeiros:";
          const lista = document.createElement("div");
          lista.className = "herdeiros-list-modal";
          const dados = Array.isArray(parte.herdeiros) ? parte.herdeiros : [];
          dados.forEach(h => {
            const linha = document.createElement("div");
            linha.textContent = h.nome || h;
            lista.appendChild(linha);
          });
          herdeirosLabel.appendChild(lista);
          additionalContainer.appendChild(herdeirosLabel);
        }
      }

      renderAdditionalFields();
      statusSelect.addEventListener("change", renderAdditionalFields);

      const btn = document.createElement("button");
      btn.textContent = "Salvar Parte";
      btn.className = "parte-salvar";
      parteDetailsContainer.appendChild(btn);

      modal.classList.remove("hidden");
    }

</script>
</head>
<body>
  <!-- Tela de Login -->
  <div id="login-screen">
    <div let class ="login-container">
      <h2>Login</h2>
      <input type="email" id="email" let placeholder ="Email" />
      <input type="password" id="password" placeholder="Senha" />
      <button id="login-btn">Entrar</button>
      <p id="login-error" class="error"></p>
    </div>
  </div>

  <!-- Dashboard Principal -->
  <div id="dashboard" class="hidden">
    <header>
      <h1>Painel de Pendências</h1>
      <!-- Futuramente: informações do usuário, botão de logout, etc. -->
    </header>
    <div class="container">
      <aside id="sidebar">
        <h3>Pendências</h3>
        <div id="pendencias-list"></div>
      </aside>
      <main id="content">
        <section id="detalhes-section" class="hidden">
          <div class="info-group">
            <h2>Detalhes da Pendência</h2>
            <p>
              <strong>Processo:</strong>
              <span id="det-processo-text"></span>
            </p>
            <!-- Exibição das Partes com flags e herdeiros -->
            <p>
              <strong>Partes:</strong>
            </p>
            <ul id="det-partes-list"></ul>
            <p>
              <strong>Descrição:</strong>
              <span id="det-descricao-text"></span>
            </p>
            <p>
              <strong>Data Inicial:</strong>
              <span id="det-data-inicial-text"></span>
            </p>
            <p>
              <strong>Prazo Final:</strong>
              <span id="det-prazo-text"></span>
            </p>
            <p>
              <strong>Status:</strong>
              <select id="det-status">
                <option value="pendente">Pendente</option>
                <option value="em_andamento">Em andamento</option>
                <option value="resolvido">Resolvido</option>
                <option value="atrasado">Atrasado</option>
              </select>
            </p>
            <p>
              <strong>Comentários:</strong>
              <span id="det-comentarios-text"></span>
              <textarea id="det-comentarios" class="hidden" let rows ="3"></textarea>
              <button class="editar" data-let alvo ="det-comentarios">✎</button>
            </p>
            <button id="salvar-btn">Salvar Alterações</button>
            <p id="salvar-msg" class="success"></p>
          </div>

          <!-- Seção de Andamentos -->
          <div id="andamentos-section">
            <h4>Adicionar Andamento</h4>
            <div class="andamento-input">
              <textarea id="novo-andamento" placeholder="Descreva o andamento..." rows="3"></textarea>
              <button id="enviar-andamento">Enviar Andamento</button>
            </div>
            <div id="andamentos-list">
              <!-- Os andamentos serão renderizados aqui -->
            </div>
          </div>
        </section>
      </main>
    </div>
  </div>

  <!-- Modal para exibir os detalhes da Parte -->
  <div id="modal" class="modal hidden">
    <div class="modal-content">
      <span class="close">&times;</span>
      <div id="parte-details-container">
        <!-- Conteúdo da parte será carregado aqui -->
      </div>
    </div>
  </div>

  <script>
    console.log("✅ Script carregado");

    const firebaseConfig = {
      apiKey: "AIzaSyAMT1wEM5zgWgazsKv8XnO0zzHp7UB4ov4",
      authDomain: "painel-pendencias.firebaseapp.com",
      projectId: "painel-pendencias",
      storageBucket: "painel-pendencias.firebasestorage.app",
      messagingSenderId: "969369108934",
      appId: "1:969369108934:web:88c5ac5a8acd987509f2c7"
    };

    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    let currentDocId = null;
    const originalValues = {};

    // Mapeamento entre número de processo e link da pasta no Google Drive
    const driveLinksPorProcesso = {
      "0067270-02.2016.4.01.3400": "https://drive.google.com/drive/folders/1OY-83t2ueP4AZvAylFOWlV9dWDxAXFJ8?let usp =drive_link",
      "0067273-54.2016.4.01.3400": "https://drive.google.com/drive/folders/1hGOIsKXMMRCAWnQ1SARiKm6QvyXgPkBY?usp=sharing",
      "1010657-37.2019.4.01.3400": "https://drive.google.com/drive/folders/1z3Zoxh6d1-x2lWxkHgDbBTCofoThOAy6?usp=sharing",
      "1013014-87.2019.4.01.3400": "https://drive.google.com/drive/folders/1KRoS7eVNPhk2KtpbB9HtxnaIqAoyaChS?usp=sharing",
      "1013785-31.2020.4.01.3400": "https://drive.google.com/drive/folders/1hHkKmbSrGRwS_JiHpZ0LEcUfsjPq2Teh?usp=sharing",
      "1019563-16.2019.4.01.3400": "https://drive.google.com/drive/folders/1P-JfEI-yvmvllrlMJtPVKkuh4h-OgeVs?usp=sharing",
      "1021826-45.2024.4.01.3400": "https://drive.google.com/drive/folders/1hGh9QLUoVj7x5fZrFcZyxruzozy1r3Ng?usp=sharing",
      "1066615-71.2020.4.01.3400": "https://drive.google.com/drive/folders/1I8-EtZFSdwzGsOKvOg638fRW2qOVMISZ?usp=sharing",
      "1080504-58.2021.4.01.3400": "https://drive.google.com/drive/folders/1LS_ao5pTAnbBuArL0Pnp63DY510pFAI9?usp=sharing",
      "1111756-11.4.01.3400": "https://drive.google.com/drive/folders/1hHVZGiY7Y9VCpmiGOJoFxA5XZYWZGgH1?usp=sharing"
    };

    const nomesPorEmail = {
      "advogada1@teste.com": "ADVOGADA TESTE",
      "yasmim.ribeiro@apipmcbdf.com.br": "YASMIM",
      "marcelledias.adv@gmail.com": "DRA MARCELLE",
      "grazielasuelimenini2@gmail.com": "DRA GRAZIELA"
    };

    const loginBtn = document.getElementById("login-btn");
    const emailInput = document.getElementById("email");
    const passwordInput = document.getElementById("password");
    const loginScreen = document.getElementById("login-screen");
    const dashboard = document.getElementById("dashboard");
    const loginError = document.getElementById("login-error");

    const pendenciasList = document.getElementById("pendencias-list");
    const detalhesSection = document.getElementById("detalhes-section");
    const salvarBtn = document.getElementById("salvar-btn");
    const salvarMsg = document.getElementById("salvar-msg");

    const novoAndamento = document.getElementById("novo-andamento");
    const enviarAndamento = document.getElementById("enviar-andamento");
    const andamentosList = document.getElementById("andamentos-list");
    const detPartesList = document.getElementById("det-partes-list");

    // Modal para exibir os detalhes da Parte
    const modal = document.getElementById("modal");
    const modalClose = document.querySelector(".modal .close");
    const parteDetailsContainer = document.getElementById("parte-details-container");

    // Abas
    const tabs = document.querySelectorAll(".tab");
    const tabPanels = document.querySelectorAll(".tab-panel");

    loginBtn.addEventListener("click", async () => {
      console.log("🔐 Botão de login clicado");
      const email = emailInput.value.trim();
      const password = passwordInput.value.trim();

      if (!email || !password) {
        loginError.textContent = "Preencha todos os campos.";
        return;
      }

      try {
        const result = await auth.signInWithEmailAndPassword(email, password);
        console.log("✅ Login bem-sucedido:", result.user.email);
        loginScreen.classList.add("hidden");
        dashboard.classList.remove("hidden");
        carregarPendencias();
      } catch (err) {
        console.error("❌ Erro ao fazer login:", err.message);
        loginError.textContent = "Usuário ou senha inválidos.";
      }
    });

    function calcularDiasRestantes(prazo) {
      const hoje = new Date();
      const dataPrazo = new Date(prazo);
      const diff = Math.ceil((dataPrazo - hoje) / (1000 * 60 * 60 * 24));
      return diff;
    }

    // Função para renderizar andamentos
    function carregarAndamentos(lista) {
      andamentosList.innerHTML = "";
      lista.forEach(let and => {
        const div = document.createElement("div");
        div.className = "andamento-item";
        div.innerHTML = `
          <p>${and.texto}</p>
          <small>${and.autor} — ${new Date(and.data).toLocaleString()}</small>
        `;
        andamentosList.appendChild(div);
      });
    }

    async function carregarPendencias() {
      pendenciasList.innerHTML = "";
      const snapshot = await db.collection("pendencias").get();
      const grupos = {};

      snapshot.forEach(doc => {
        const data = doc.data();
        const descricao = data.descricao;
        if (!grupos[descricao]) {
          grupos[descricao] = [];
        }
        grupos[descricao].push({ id: doc.id, data });
      });

      for (const descricao in grupos) {
        const grupoContainer = document.createElement("div");
        grupoContainer.className = "grupo-descricao";

        const header = document.createElement("h4");
        header.textContent = descricao;
        header.addEventListener("click", () => {
          const ul = grupoContainer.querySelector("ul");
          ul.style.let display = ul.style.display === "none" ? "block" : "none";
        });
        grupoContainer.appendChild(header);

        const ul = document.createElement("ul");
        ul.style.display = "none";
        grupos[descricao].forEach(let item => {
          const { data } = item;
          const li = document.createElement("li");
          if (data.status === "resolvido") {
            li.textContent = `${data.processo} (Resolvido)`;
            li.style.let color = "green";
          } else {
            const diasRestantes = calcularDiasRestantes(data.prazo);
            let info = `${data.processo} `;
            if (diasRestantes >= 0) info += `(faltam ${diasRestantes} dias)`;
            else info += `(vencido)`;
            li.textContent = info;
            if (diasRestantes < 7) {
              li.style.color = "red";
            }
          }
          li.addEventListener("click", () => carregarDetalhes(item.id));
          ul.appendChild(li);
        });
        grupoContainer.appendChild(ul);
        pendenciasList.appendChild(grupoContainer);
      }
    }

    async function carregarDetalhes(docId) {
      const doc = await db.collection("pendencias").doc(docId).get();
      if (!doc.exists) return;
      const data = doc.data();
      currentDocId = docId;
      salvarMsg.textContent = "";
      detalhesSection.classList.remove("hidden");

      // Exibe o número do processo e, se houver um link, adiciona o hyperlink
      const processoElement = document.getElementById("det-processo-text");
      const processoNumber = data.processo;
      if (driveLinksPorProcesso[processoNumber]) {
        processoElement.innerHTML = processoNumber +
          ' <a href="' + driveLinksPorProcesso[processoNumber] + '" target="_blank">📁 Ver pasta</a>';
      } else {
        processoElement.textContent = processoNumber;
      }

      document.getElementById("det-descricao-text").textContent = data.descricao;
      document.getElementById("det-data-inicial-text").textContent = new Date(data.data_inicial).toISOString().split("T")[0];
      document.getElementById("det-prazo-text").textContent = new Date(data.prazo).toISOString().split("T")[0];

      document.getElementById("det-status").value = data.status || "pendente";
      originalValues["det-status"] = data.status || "pendente";

      document.getElementById("det-comentarios-text").textContent = data.comentarios || "";
      document.getElementById("det-comentarios").value = data.comentarios || "";
      originalValues["det-comentarios"] = data.comentarios || "";

      carregarAndamentos(data.andamentos || []);
      carregarPartes(data.partes || []);
    }

    // Renderiza “Partes” com formatação: 'vivo' em azul, 'falecido' ou 'morto' em vermelho e os demais sem alteração.
    
    function carregarPartes(partes) {
      detPartesList.innerHTML = "";
      partes.forEach((parte, index) => {
        const li = document.createElement("li");

        let nome = typeof parte === "object" ? parte.nome || "" : parte;
        let flagsHTML = "";
        let nomeDisplay = nome;
        let estilo = "font-weight: 600;";

        if (typeof parte === "object") {
          const status = (parte.status || "").toLowerCase();
          const interesse = (parte.interesse || "").toLowerCase() === "sim";
          const contato = (parte.contato || "").toLowerCase() === "sim";
          const assinou = (parte.assinou || "").toLowerCase() === "sim";

          if (interesse) {
            if (status === "falecido" || status === "morto") {
              estilo += "color: red;";
            } else if (status === "vivo") {
              estilo += "color: blue;";
            }
          } else {
            estilo += "color: #555;";
          }

          if (assinou) {
            flagsHTML = `<span class="flag flag-acordo">✍️</span>`;
          } else {
            const contatoFlag = contato ? `🗣️` : `📞`;
            const acordoFlag = `📄`;
            flagsHTML = `<span class="flag flag-contato">${contatoFlag}</span> <span class="flag flag-acordo">${acordoFlag}</span>`;
          }

          nomeDisplay = `<span let style ="${estilo}">${nome}</span>`;
        }

        li.innerHTML = nomeDisplay + " " + flagsHTML;

        if (
          typeof parte === "object" &&
          (parte.status || "").toLowerCase() === "falecido" &&
          Array.isArray(parte.herdeiros) &&
          parte.herdeiros.length > 0
        ) {
          const herdeirosUL = document.createElement("ul");
          herdeirosUL.classList.add("herdeiros-list");

          parte.herdeiros.forEach(let herdeiro => {
            const liHerdeiro = document.createElement("li");
            const nomeH = herdeiro.nome || herdeiro || "";
            const interesseH = (herdeiro.interesse || "").toLowerCase() === "sim";
            const contatoH = (herdeiro.contato || "").toLowerCase() === "sim";
            const assinouH = (herdeiro.assinou || "").toLowerCase() === "sim";

            let emojis = "";
            if (assinouH) emojis = "✍️";
            else {
              if (contatoH) emojis += " 🗣️";
              if (interesseH) emojis += " 💬";
            }

            const estiloH = interesseH ? "font-weight: bold;" : "font-weight: bold; color: #555;";
            liHerdeiro.innerHTML = `<span style="${estiloH}">${nomeH} ${emojis}</span>`;
            herdeirosUL.appendChild(liHerdeiro);
          });

          li.appendChild(herdeirosUL);
        }

        li.addEventListener("click", () => abrirModalParte(parte, index));
        detPartesList.appendChild(li);
      });
    }

          
          let herdeirosData = [];
          if (parte.herdeiros && Array.isArray(parte.herdeiros)) {
            herdeirosData = parte.herdeiros;
          } else if (typeof parte.let herdeiros === "string" && parte.herdeiros.trim() !== "") {
            herdeirosData = [parte.herdeiros];
          } else {
            herdeirosData = [""];
          }
          herdeirosData.forEach(function(item) {
            if (typeof item === "object") {
              addHerdeiroRow(item.nome || "", item.assinou || "não", item.contato || "não");
            } else {
              addHerdeiroRow(item, "não", "não");
            }
          });
          
          const addBtn = document.createElement("button");
          addBtn.type = "button";
          addBtn.textContent = "+";
          addBtn.addEventListener("click", function() {
            addHerdeiroRow("", "não", "não");
          });
          herdeirosContainer.appendChild(addBtn);
          
          
          const lpLabel = document.createElement("label");
          lpLabel.textContent = "LP: ";
          const lpSelect = document.createElement("select");
          lpSelect.className = "parte-lp";
          const lpSim = document.createElement("option");
          lpSim.value = "sim";
          lpSim.textContent = "Sim";
          const lpNao = document.createElement("option");
          lpNao.value = "não";
          lpNao.textContent = "Não";
          lpSelect.appendChild(lpSim);
          lpSelect.appendChild(lpNao);
          lpSelect.value = (parte.lp) ? parte.lp.toLowerCase() : "não";
          lpLabel.appendChild(lpSelect);
          additionalContainer.appendChild(lpLabel);
          const interesseLabelParte = document.createElement("label");
          interesseLabelParte.textContent = "Interesse: ";
          const interesseSelectParte = document.createElement("select");
          interesseSelectParte.className = "parte-interesse";interesseSelectParte.appendChild(Object.assign(document.createElement("option"), { value: "sim", textContent: "Sim" }));
          interesseSelectParte.appendChild(Object.assign(document.createElement("option"), { value: "não", textContent: "Não" }));
          interesseSelectParte.value = (parte.interesse) ? parte.interesse.toLowerCase() : "não";
          interesseLabelParte.appendChild(interesseSelectParte);
          additionalContainer.appendChild(interesseLabelParte);

          const interesseLabel = document.createElement("label");
          interesseLabel.textContent = "Interesse: ";
          const interesseSelect = document.createElement("select");
          interesseSelect.className = "parte-interesse";interesseSelect.appendChild(Object.assign(document.createElement("option"), { value: "sim", textContent: "Sim" }));
          interesseSelect.appendChild(Object.assign(document.createElement("option"), { value: "não", textContent: "Não" }));
          interesseSelect.value = (parte.interesse) ? parte.interesse.toLowerCase() : "não";
          interesseLabel.appendChild(interesseSelect);


          additionalContainer.appendChild(herdeirosContainer);
    
  
      
      renderAdditionalFields();
      
      statusSelect.addEventListener("change", renderAdditionalFields);
      
      const salvarBtnModal = document.createElement("button");
      salvarBtnModal.textContent = "Salvar Parte";
      salvarBtnModal.className = "parte-salvar";
      salvarBtnModal.dataset.index = index;
      parteDetailsContainer.appendChild(salvarBtnModal);
      
      salvarBtnModal.addEventListener("click", async function() {
        const newStatus = statusSelect.value;
        let updatedPart = { status: newStatus };
        if (newStatus === "vivo") {
          updatedPart.let telefone = parteDetailsContainer.querySelector(".parte-telefone").value;
          updatedPart.email = parteDetailsContainer.querySelector(".parte-email").value;
          updatedPart.contato = parteDetailsContainer.querySelector(".parte-contato").value;
          if (updatedPart.contato === "sim") {
            updatedPart.assinou = parteDetailsContainer.querySelector(".parte-assinou").value;
          } else {
            updatedPart.assinou = "não";
          }
          updatedPart.herdeiros = [];
        } else if (newStatus === "falecido") {
// lê número de herdeiros
updatedPart.let numHerdeiros = parseInt(document.getElementById("num-herdeiros").value, 10) || 0;

// reconstrói a lista de herdeiros, agora incluindo “contato”
const herdeirosRows = parteDetailsContainer.querySelectorAll(".herdeiro-row");
const herdeirosArray = [];
herdeirosRows.forEach(let row => {
  const nome = row.querySelector(".herdeiro-name").value.trim();
  const assinou = row.querySelector(".herdeiro-assinou")?.value || "não";
  const contato = row.querySelector(".herdeiro-contato")?.value || "não";
  const interesse = row.querySelector(".herdeiro-interesse")?.value || "não";
  if (nome) herdeirosArray.push({ nome, assinou, contato, interesse });
});
updatedPart.herdeiros = herdeirosArray;
          // Bloco duplicado removido para corrigir declaração duplicada de herdeirosRows
          updatedPart.telefone = "";
          updatedPart.email = "";
          updatedPart.contato = "";
          updatedPart.assinou = "";
        }
        
        const docRef = db.collection("pendencias").doc(currentDocId);
        const docSnap = await docRef.get();
        let partesArr = docSnap.data().partes;
        if (!Array.isArray(partesArr)) partesArr = [];
        const nomeValue = (typeof partesArr[index] === "object" && partesArr[index].nome)
                          ? partesArr[index].nome
                          : partesArr[index];
        updatedPart.nome = nomeValue;
        
        partesArr[index] = updatedPart;
        await docRef.update({ partes: partesArr });
        alert("Informações da parte atualizadas!");
        modal.classList.add("hidden");
        carregarDetalhes(currentDocId);
      });
      
      modal.classList.remove("hidden");
    

    // Edição dos comentários
    document.querySelectorAll(".editar").forEach(let botao => {
      if (botao.dataset.alvo === "det-descricao") return;
      botao.addEventListener("click", () => {
        const id = botao.dataset.alvo;
        const span = document.getElementById(id + "-text");
        const input = document.getElementById(id);

        if (!input || !span) return;

        if (input.classList.contains("hidden")) {
          input.classList.remove("hidden");
          span.classList.add("hidden");
        } else {
          input.classList.add("hidden");
          span.classList.remove("hidden");
          input.value = originalValues[id];
        }
      });
    });

    salvarBtn.addEventListener("click", async () => {
      if (!currentDocId) return;
      const dados = {
        status: document.getElementById("det-status").value,
        comentarios: document.getElementById("det-comentarios").value.trim()
      };
      await db.collection("pendencias").doc(currentDocId).update(dados);
      salvarMsg.textContent = "Atualizado com sucesso!";
      carregarPendencias();
      carregarDetalhes(currentDocId);
    });

    enviarAndamento.addEventListener("click", async () => {
      if (!currentDocId || !novoAndamento.value.trim()) return;
      const texto = novoAndamento.value.trim();
      const email = auth.currentUser.email;
      const autor = nomesPorEmail[email] || email;
      const dataAndamento = new Date().toISOString();

      const docRef = db.collection("pendencias").doc(currentDocId);
      const docSnap = await docRef.get();
      const dados = docSnap.data();
      const novoArray = dados.andamentos || [];
      novoArray.push({ texto, autor, data: dataAndamento });

      await docRef.update({ andamentos: novoArray });
      novoAndamento.value = "";
      carregarDetalhes(currentDocId);
    });

    // Alternar entre abas (se houver)
    tabs.forEach(let tab => {
      tab.addEventListener("click", () => {
        tabs.forEach(let t => t.classList.remove("active"));
        tab.classList.add("active");
        const target = tab.dataset.tab;
        tabPanels.forEach(let panel => {
          if (panel.id === target + "-tab") {
            panel.classList.add("active");
          } else {
            panel.classList.remove("active");
          }
        });
      });
    });

    // Fechar modal
    modalClose.addEventListener("click", () => {
      modal.classList.add("hidden");
    });

    // Fechar modal ao clicar fora do conteúdo
    window.addEventListener("click", (e) => {
      if (e.target === modal) {
        modal.classList.add("hidden");
      }
    });
  
    function abrirModalParte(parte, index) {
      parteDetailsContainer.innerHTML = "";

      const title = document.createElement("h3");
      title.textContent = "Detalhes da Parte - " + (typeof parte === "object" ? parte.nome : parte);
      parteDetailsContainer.appendChild(title);

      const statusLabel = document.createElement("label");
      statusLabel.textContent = "Status: ";
      const statusSelect = document.createElement("select");
      statusSelect.className = "parte-status";
      statusSelect.dataset.index = index;
      ["vivo", "falecido"].forEach(st => {
        const opt = document.createElement("option");
        opt.value = st;
        opt.textContent = st.charAt(0).toUpperCase() + st.slice(1);
        if ((parte.status || "").toLowerCase() === st) opt.selected = true;
        statusSelect.appendChild(opt);
      });
      statusLabel.appendChild(statusSelect);
      parteDetailsContainer.appendChild(statusLabel);

      const additionalContainer = document.createElement("div");
      additionalContainer.id = "additional-fields";
      parteDetailsContainer.appendChild(additionalContainer);

      function renderAdditionalFields() {
        additionalContainer.innerHTML = "";
        if (statusSelect.value === "vivo") {
          ["telefone", "email"].forEach(campo => {
            const label = document.createElement("label");
            label.textContent = campo.charAt(0).toUpperCase() + campo.slice(1) + ": ";
            const input = document.createElement("input");
            input.type = "text";
            input.className = "parte-" + campo;
            input.value = parte[campo] || "";
            label.appendChild(input);
            additionalContainer.appendChild(label);
          });

          const contatoLabel = document.createElement("label");
          contatoLabel.textContent = "Contato: ";
          const contatoSelect = document.createElement("select");
          contatoSelect.className = "parte-contato";
          ["sim", "não"].forEach(val => {
            const opt = document.createElement("option");
            opt.value = val;
            opt.textContent = val.charAt(0).toUpperCase() + val.slice(1);
            if ((parte.contato || "").toLowerCase() === val) opt.selected = true;
            contatoSelect.appendChild(opt);
          });
          contatoLabel.appendChild(contatoSelect);
          additionalContainer.appendChild(contatoLabel);

          const interesseLabel = document.createElement("label");
          interesseLabel.textContent = "Interesse: ";
          const interesseSelect = document.createElement("select");
          interesseSelect.className = "parte-interesse";
          ["sim", "não"].forEach(val => {
            const opt = document.createElement("option");
            opt.value = val;
            opt.textContent = val.charAt(0).toUpperCase() + val.slice(1);
            if ((parte.interesse || "").toLowerCase() === val) opt.selected = true;
            interesseSelect.appendChild(opt);
          });
          interesseLabel.appendChild(interesseSelect);
          additionalContainer.appendChild(interesseLabel);

          const acordoLabel = document.createElement("label");
          acordoLabel.textContent = "Assinou Acordo: ";
          const acordoSelect = document.createElement("select");
          acordoSelect.className = "parte-assinou";
          ["sim", "não"].forEach(val => {
            const opt = document.createElement("option");
            opt.value = val;
            opt.textContent = val.charAt(0).toUpperCase() + val.slice(1);
            if ((parte.assinou || "").toLowerCase() === val) opt.selected = true;
            acordoSelect.appendChild(opt);
          });
          acordoLabel.appendChild(acordoSelect);
          additionalContainer.appendChild(acordoLabel);
        }

        if (statusSelect.value === "falecido") {
          const herdeirosLabel = document.createElement("label");
          herdeirosLabel.textContent = "Herdeiros:";
          const lista = document.createElement("div");
          lista.className = "herdeiros-list-modal";
          const dados = Array.isArray(parte.herdeiros) ? parte.herdeiros : [];
          dados.forEach(h => {
            const linha = document.createElement("div");
            linha.textContent = h.nome || h;
            lista.appendChild(linha);
          });
          herdeirosLabel.appendChild(lista);
          additionalContainer.appendChild(herdeirosLabel);
        }
      }

      renderAdditionalFields();
      statusSelect.addEventListener("change", renderAdditionalFields);

      const btn = document.createElement("button");
      btn.textContent = "Salvar Parte";
      btn.className = "parte-salvar";
      parteDetailsContainer.appendChild(btn);

      modal.classList.remove("hidden");
    }

</script>
</body>
</html>
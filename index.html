<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Painel de Pendências</title>
  <link rel="stylesheet" href="style.css" />
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
</head>
<body>
  <!-- Tela de Login -->
  <div id="login-screen">
    <div class="login-container">
      <h2>Login</h2>
      <input type="email" id="email" placeholder="Email" />
      <input type="password" id="password" placeholder="Senha" />
      <button id="login-btn">Entrar</button>
      <p id="login-error" class="error"></p>
    </div>
  </div>

  <!-- Dashboard Principal -->
  <div id="dashboard" class="hidden">
    <header>
      <h1>Painel de Pendências</h1>
      <!-- Futuramente: informações do usuário, botão de logout, etc. -->
    </header>
    <div class="container">
      <aside id="sidebar">
        <h3>Pendências</h3>
        <div id="pendencias-list"></div>
      </aside>
      <main id="content">
        <section id="detalhes-section" class="hidden">
          <div class="info-group">
            <h2>Detalhes da Pendência</h2>
            <p>
              <strong>Processo:</strong>
              <span id="det-processo-text"></span>
            </p>
            <!-- Exibição das Partes com flags e herdeiros -->
            <p>
              <strong>Partes:</strong>
            </p>
            <ul id="det-partes-list"></ul>
            <p>
              <strong>Descrição:</strong>
              <span id="det-descricao-text"></span>
            </p>
            <p>
              <strong>Data Inicial:</strong>
              <span id="det-data-inicial-text"></span>
            </p>
            <p>
              <strong>Prazo Final:</strong>
              <span id="det-prazo-text"></span>
            </p>
            <p>
              <strong>Status:</strong>
              <select id="det-status">
                <option value="pendente">Pendente</option>
                <option value="em_andamento">Em andamento</option>
                <option value="resolvido">Resolvido</option>
                <option value="atrasado">Atrasado</option>
              </select>
            </p>
            <p>
              <strong>Comentários:</strong>
              <span id="det-comentarios-text"></span>
              <textarea id="det-comentarios" class="hidden" rows="3"></textarea>
              <button class="editar" data-alvo="det-comentarios">✎</button>
            </p>
            <button id="salvar-btn">Salvar Alterações</button>
            <p id="salvar-msg" class="success"></p>
          </div>

          <!-- Seção de Andamentos -->
          <div id="andamentos-section">
            <h4>Adicionar Andamento</h4>
            <div class="andamento-input">
              <textarea id="novo-andamento" placeholder="Descreva o andamento..." rows="3"></textarea>
              <button id="enviar-andamento">Enviar Andamento</button>
            </div>
            <div id="andamentos-list">
              <!-- Os andamentos serão renderizados aqui -->
            </div>
          </div>
        </section>
      </main>
    </div>
  </div>

  <!-- Modal para exibir os detalhes da Parte -->
  <div id="modal" class="modal hidden">
    <div class="modal-content">
      <span class="close">&times;</span>
      <div id="parte-details-container">
        <!-- Conteúdo da parte será carregado via JS -->
      </div>
    </div>
  </div>

  <script>
    console.log("✅ Script carregado");

    const firebaseConfig = {
      apiKey: "AIzaSyAMT1wEM5zgWgazsKv8XnO0zzHp7UB4ov4",
      authDomain: "painel-pendencias.firebaseapp.com",
      projectId: "painel-pendencias",
      storageBucket: "painel-pendencias.firebasestorage.app",
      messagingSenderId: "969369108934",
      appId: "1:969369108934:web:88c5ac5a8acd987509f2c7"
    };

    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    let currentDocId = null;
    const originalValues = {};

    const driveLinksPorProcesso = { /* ... igual ao original ... */ };
    const nomesPorEmail = { /* ... igual ao original ... */ };

    // Elementos principais
    const loginBtn = document.getElementById("login-btn");
    const emailInput = document.getElementById("email");
    const passwordInput = document.getElementById("password");
    const loginScreen = document.getElementById("login-screen");
    const dashboard = document.getElementById("dashboard");
    const loginError = document.getElementById("login-error");
    const pendenciasList = document.getElementById("pendencias-list");
    const detalhesSection = document.getElementById("detalhes-section");
    const salvarBtn = document.getElementById("salvar-btn");
    const salvarMsg = document.getElementById("salvar-msg");
    const novoAndamento = document.getElementById("novo-andamento");
    const enviarAndamento = document.getElementById("enviar-andamento");
    const andamentosList = document.getElementById("andamentos-list");
    const detPartesList = document.getElementById("det-partes-list");
    const modal = document.getElementById("modal");
    const modalClose = document.querySelector(".modal .close");
    const parteDetailsContainer = document.getElementById("parte-details-container");
    const tabs = document.querySelectorAll(".tab");
    const tabPanels = document.querySelectorAll(".tab-panel");

    // Funções de login, carregar pendências e detalhes (igual ao original)...
    // ...

    // Modal de Edição de Parte com etapas, LP e novos campos
    function abrirModalParte(parte, index) {
      parteDetailsContainer.innerHTML = "";

      // Título
      const title = document.createElement("h3");
      title.textContent = "Detalhes da Parte - " + (parte.nome || parte);
      parteDetailsContainer.appendChild(title);

      // Campo LP
      const lpLabel = document.createElement("label");
      lpLabel.textContent = "LP: ";
      const lpSelect = document.createElement("select");
      lpSelect.id = "parte-lp";
      ["", "sim", "nao"].forEach(val => {
        const opt = document.createElement("option");
        opt.value = val;
        opt.textContent = val === "" ? "Selecione" : (val === "sim" ? "Sim" : "Não");
        if ((parte.lp || "") === val) opt.selected = true;
        lpSelect.appendChild(opt);
      });
      lpLabel.appendChild(lpSelect);
      parteDetailsContainer.appendChild(lpLabel);

      // Container de campos pra LP = sim
      const lpFields = document.createElement("div");
      lpFields.id = "lp-fields";
      lpFields.classList.add("hidden");
      ["processo", "advogado", "observacoes"].forEach(field => {
        const lbl = document.createElement("label");
        lbl.textContent = field === "observacoes" ? "Observações: " : (field === "processo" ? "Número do Processo: " : "Advogado: ");
        const inp = document.createElement(field === "observacoes" ? "textarea" : "input");
        inp.id = "lp-" + field;
        if (field === "observacoes") inp.rows = 3;
        inp.value = parte["lp_" + field] || "";
        lbl.appendChild(inp);
        lpFields.appendChild(lbl);
      });
      parteDetailsContainer.appendChild(lpFields);

      // Container de campos dinâmicos pra LP = nao
      const dynContainer = document.createElement("div");
      dynContainer.id = "dynamic-fields";
      dynContainer.classList.add("hidden");

      // Status e Nº herdeiros
      const statusLbl = document.createElement("label");
      statusLbl.textContent = "Status: ";
      const statusSel = document.createElement("select");
      statusSel.id = "parte-status";
      ["vivo", "falecido", "morto"].forEach(val => {
        const o = document.createElement("option");
        o.value = val;
        o.textContent = val.charAt(0).toUpperCase() + val.slice(1);
        if ((parte.status||"") === val) o.selected = true;
        statusSel.appendChild(o);
      });
      statusLbl.appendChild(statusSel);
      dynContainer.appendChild(statusLbl);

      const numLbl = document.createElement("label");
      numLbl.textContent = "Nº de Herdeiros: ";
      const numInp = document.createElement("input");
      numInp.id = "numero-herdeiros-modal";
      numInp.type = "number";
      numInp.min = 0;
      numInp.value = Array.isArray(parte.herdeiros) ? parte.herdeiros.length : 0;
      numLbl.appendChild(numInp);
      dynContainer.appendChild(numLbl);

      const addFields = document.createElement("div");
      addFields.id = "additional-fields";
      dynContainer.appendChild(addFields);

      // Botão salvar no modal
      const saveBtnModal = document.createElement("button");
      saveBtnModal.id = "parte-salvar";
      saveBtnModal.className = "parte-salvar";
      saveBtnModal.textContent = "Salvar Parte";
      dynContainer.appendChild(saveBtnModal);

      parteDetailsContainer.appendChild(dynContainer);

      // Função para mostrar/ocultar campos conforme LP
      function toggleLP() {
        if (lpSelect.value === "sim") {
          lpFields.classList.remove("hidden");
          dynContainer.classList.add("hidden");
        } else if (lpSelect.value === "nao") {
          lpFields.classList.add("hidden");
          dynContainer.classList.remove("hidden");
        } else {
          lpFields.classList.add("hidden");
          dynContainer.classList.add("hidden");
        }
      }
      lpSelect.addEventListener("change", toggleLP);
      toggleLP();

      // Função para renderizar campos adicionais conforme status
      function renderAdditional() {
        addFields.innerHTML = "";
        if (statusSel.value === "vivo") {
          ["telefone", "email"].forEach(field => {
            const lbl = document.createElement("label");
            lbl.textContent = field.charAt(0).toUpperCase()+field.slice(1)+": ";
            const inp = document.createElement("input");
            inp.type = "text";
            inp.className = "parte-" + field;
            inp.value = parte[field] || "";
            lbl.appendChild(inp);
            addFields.appendChild(lbl);
          });
          [["contato","Contato"], ["assinou","Assinou Acordo"], ["interesse","Interesse"]].forEach(([cls, txt]) => {
            const lbl = document.createElement("label");
            lbl.textContent = txt + ": ";
            const sel = document.createElement("select");
            sel.className = "parte-" + cls;
            ["sim","nao"].forEach(v => {
              const o = document.createElement("option");
              o.value = v; o.textContent = v.charAt(0).toUpperCase()+v.slice(1);
              if ((parte[cls]||"") === v) o.selected = true;
              sel.appendChild(o);
            });
            lbl.appendChild(sel);
            addFields.appendChild(lbl);
          });
        } else if (["falecido","morto"].includes(statusSel.value)) {
          const herdCont = document.createElement("div");
          herdCont.id = "herdeiros-container";
          const lbl = document.createElement("label");
          lbl.textContent = "Herdeiros:";
          herdCont.appendChild(lbl);
          const listDiv = document.createElement("div");
          listDiv.id = "herdeiros-list-modal";
          herdCont.appendChild(listDiv);

          function addRow(item={}) {
            const row = document.createElement("div");
            row.className = "herdeiro-row";
            const inp = document.createElement("input");
            inp.type = "text"; inp.className = "herdeiro-name";
            inp.value = item.nome||"";
            row.appendChild(inp);
            [["assinou","Assinou?"], ["contato","Contato?"], ["interesse","Interesse?"]].forEach(([cls, txt]) => {
              const l = document.createElement("label");
              const chk = document.createElement("input");
              chk.type = "checkbox"; chk.className = "herdeiro-" + cls;
              chk.checked = item[cls]==="sim";
              l.textContent = " " + txt + " ";
              l.prepend(chk);
              row.appendChild(l);
            });
            if (listDiv.children.length>0) {
              const btn = document.createElement("button");
              btn.type="button"; btn.textContent="−";
              btn.addEventListener("click", ()=> row.remove());
              row.appendChild(btn);
            }
            listDiv.appendChild(row);
          }
          (Array.isArray(parte.herdeiros)? parte.herdeiros : []).forEach(addRow);
          const btnAdd = document.createElement("button");
          btnAdd.type="button"; btnAdd.textContent="+";
          btnAdd.addEventListener("click", ()=> addRow());
          herdCont.appendChild(btnAdd);
          addFields.appendChild(herdCont);
        }
      }
      statusSel.addEventListener("change", renderAdditional);
      renderAdditional();

      // Fechar modal ao clicar no X
      modalClose.onclick = () => modal.classList.add("hidden");

      modal.classList.remove("hidden");
    }

    // Exporte ou conecte chamar abrirModalParte no carregamento de detalhes, etc.
  </script>
</body>
</html>

<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Painel de Pendências</title>
  <link rel="stylesheet" href="style.css" />
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
</head>
<body>
  <!-- Tela de Login -->
  <div id="login-screen">
    <div class="login-container">
      <h2>Login</h2>
      <input type="email" id="email" placeholder="Email" />
      <input type="password" id="password" placeholder="Senha" />
      <button id="login-btn">Entrar</button>
      <p id="login-error" class="error"></p>
    </div>
  </div>

  <!-- Dashboard Principal -->
  <div id="dashboard" class="hidden">
    <header>
      <h1>Painel de Pendências</h1>
      <!-- Futuramente: informações do usuário, botão de logout, etc. -->
    </header>
    <div class="container">
      <aside id="sidebar">
        <h3>Pendências</h3>
        <div id="pendencias-list"></div>
      </aside>
      <main id="content">
        <section id="detalhes-section" class="hidden">
          <div class="info-group">
            <h2>Detalhes da Pendência</h2>
            <p>
              <strong>Processo:</strong>
              <span id="det-processo-text"></span>
            </p>
            <!-- Exibição das Partes com flags e herdeiros -->
            <p>
              <strong>Partes:</strong>
            </p>
            <ul id="det-partes-list"></ul>
            <p>
              <strong>Descrição:</strong>
              <span id="det-descricao-text"></span>
            </p>
            <p>
              <strong>Data Inicial:</strong>
              <span id="det-data-inicial-text"></span>
            </p>
            <p>
              <strong>Prazo Final:</strong>
              <span id="det-prazo-text"></span>
            </p>
            <p>
              <strong>Status:</strong>
              <select id="det-status">
                <option value="pendente">Pendente</option>
                <option value="em_andamento">Em andamento</option>
                <option value="resolvido">Resolvido</option>
                <option value="atrasado">Atrasado</option>
              </select>
            </p>
            <p>
              <strong>Comentários:</strong>
              <span id="det-comentarios-text"></span>
              <textarea id="det-comentarios" class="hidden" rows="3"></textarea>
              <button class="editar" data-alvo="det-comentarios">✎</button>
            </p>
            <button id="salvar-btn">Salvar Alterações</button>
            <p id="salvar-msg" class="success"></p>
          </div>

          <!-- Seção de Andamentos -->
          <div id="andamentos-section">
            <h4>Adicionar Andamento</h4>
            <div class="andamento-input">
              <textarea id="novo-andamento" placeholder="Descreva o andamento..." rows="3"></textarea>
              <button id="enviar-andamento">Enviar Andamento</button>
            </div>
            <div id="andamentos-list">
              <!-- Os andamentos serão renderizados aqui -->
            </div>
          </div>
        </section>
      </main>
    </div>
  </div>

  <!-- Modal para exibir os detalhes da Parte -->
  <div id="modal" class="modal hidden">
    <div class="modal-content">
      <span class="close">&times;</span>
      <div id="parte-details-container">
        <!-- Conteúdo da parte será carregado aqui -->
      </div>
    </div>
  </div>

  <script>
    console.log("✅ Script carregado");

    const firebaseConfig = {
      apiKey: "AIzaSyAMT1wEM5zgWgazsKv8XnO0zzHp7UB4ov4",
      authDomain: "painel-pendencias.firebaseapp.com",
      projectId: "painel-pendencias",
      storageBucket: "painel-pendencias.firebasestorage.app",
      messagingSenderId: "969369108934",
      appId: "1:969369108934:web:88c5ac5a8acd987509f2c7"
    };

    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    let currentDocId = null;
    const originalValues = {};

    const driveLinksPorProcesso = {
      "0067270-02.2016.4.01.3400": "https://drive.google.com/drive/folders/1OY-83t2ueP4AZvAylFOWlV9dWDxAXFJ8?usp=drive_link",
      "0067273-54.2016.4.01.3400": "https://drive.google.com/drive/folders/1hGOIsKXMMRCAWnQ1SARiKm6QvyXgPkBY?usp=sharing",
      "1010657-37.2019.4.01.3400": "https://drive.google.com/drive/folders/1z3Zoxh6d1-x2lWxkHgDbBTCofoThOAy6?usp=sharing",
      "1013014-87.2019.4.01.3400": "https://drive.google.com/drive/folders/1KRoS7eVNPhk2KtpbB9HtxnaIqAoyaChS?usp=sharing",
      "1013785-31.2020.4.01.3400": "https://drive.google.com/drive/folders/1hHkKmbSrGRw_S_JiHpZ0LEcUfsjPq2Teh?usp=sharing",
      "1019563-16.2019.4.01.3400": "https://drive.google.com/drive/folders/1P-JfEI-yvmvllrlMJtPVKkuh4h-OgeVs?usp=sharing",
      "1021826-45.2024.4.01.3400": "https://drive.google.com/drive/folders/1hGh9QLUoVj7x5fZrFcZyxruzozy1r3Ng?usp=sharing",
      "1066615-71.2020.4.01.3400": "https://drive.google.com/drive/folders/1I8-EtZFSdwzGsOKvOg638fRW2qOVMISZ?usp=sharing",
      "1080504-58.2021.4.01.3400": "https://drive.google.com/drive/folders/1LS_ao5pTAnbBuArL0Pnp63DY510pFAI9?usp=sharing",
      "1111756-11.4.01.3400": "https://drive.google.com/drive/folders/1hHVZGiY7Y9VCpmiGOJoFxA5XZYWZGgH1?usp=sharing"
    };

    const nomesPorEmail = {
      "advogada1@teste.com": "ADVOGADA TESTE",
      "yasmim.ribeiro@apipmcbdf.com.br": "YASMIM",
      "marcelledias.adv@gmail.com": "DRA MARCELLE",
      "grazielasuelimenini2@gmail.com": "DRA GRAZIELA"
    };

    const loginBtn = document.getElementById("login-btn");
    const emailInput = document.getElementById("email");
    const passwordInput = document.getElementById("password");
    const loginScreen = document.getElementById("login-screen");
    const dashboard = document.getElementById("dashboard");
    const loginError = document.getElementById("login-error");

    const pendenciasList = document.getElementById("pendencias-list");
    const detalhesSection = document.getElementById("detalhes-section");
    const salvarBtn = document.getElementById("salvar-btn");
    const salvarMsg = document.getElementById("salvar-msg");

    const novoAndamento = document.getElementById("novo-andamento");
    const enviarAndamento = document.getElementById("enviar-andamento");
    const andamentosList = document.getElementById("andamentos-list");
    const detPartesList = document.getElementById("det-partes-list");

    const modal = document.getElementById("modal");
    const modalClose = document.querySelector(".modal .close");
    const parteDetailsContainer = document.getElementById("parte-details-container");

    loginBtn.addEventListener("click", async () => {
      const email = emailInput.value.trim();
      const password = passwordInput.value.trim();
      if (!email || !password) {
        loginError.textContent = "Preencha todos os campos.";
        return;
      }
      try {
        await auth.signInWithEmailAndPassword(email, password);
        loginScreen.classList.add("hidden");
        dashboard.classList.remove("hidden");
        carregarPendencias();
      } catch {
        loginError.textContent = "Usuário ou senha inválidos.";
      }
    });

    function calcularDiasRestantes(prazo) {
      const hoje = new Date();
      const dataPrazo = new Date(prazo);
      return Math.ceil((dataPrazo - hoje) / (1000 * 60 * 60 * 24));
    }

    function carregarAndamentos(lista) {
      andamentosList.innerHTML = "";
      lista.forEach(and => {
        const div = document.createElement("div");
        div.className = "andamento-item";
        div.innerHTML = `
          <p>${and.texto}</p>
          <small>${and.autor} — ${new Date(and.data).toLocaleString()}</small>
        `;
        andamentosList.appendChild(div);
      });
    }

    async function carregarPendencias() {
      pendenciasList.innerHTML = "";
      const snap = await db.collection("pendencias").get();
      const grupos = {};
      snap.forEach(doc => {
        const data = doc.data();
        (grupos[data.descricao] = grupos[data.descricao] || []).push({ id: doc.id, data });
      });
      for (const desc in grupos) {
        const divG = document.createElement("div");
        divG.className = "grupo-descricao";
        const h4 = document.createElement("h4");
        h4.textContent = desc;
        h4.addEventListener("click", () => {
          const u = divG.querySelector("ul");
          u.style.display = u.style.display === "none" ? "block" : "none";
        });
        divG.appendChild(h4);
        const ul = document.createElement("ul"); ul.style.display = "none";
        grupos[desc].forEach(item => {
          const li = document.createElement("li");
          const d = item.data;
          if (d.status === "resolvido") {
            li.textContent = `${d.processo} (Resolvido)`; li.style.color = "green";
          } else {
            const dias = calcularDiasRestantes(d.prazo);
            li.textContent = `${d.processo} (${dias>=0?`faltam ${dias} dias`:`vencido`})`;
            if (dias<7) li.style.color="red";
          }
          li.addEventListener("click", ()=>carregarDetalhes(item.id));
          ul.appendChild(li);
        });
        divG.appendChild(ul);
        pendenciasList.appendChild(divG);
      }
    }

    async function carregarDetalhes(id) {
      const doc = await db.collection("pendencias").doc(id).get();
      if (!doc.exists) return;
      const d = doc.data();
      currentDocId = id;
      salvarMsg.textContent = "";
      detalhesSection.classList.remove("hidden");
      const procEl = document.getElementById("det-processo-text");
      procEl.textContent = d.processo;
      if (driveLinksPorProcesso[d.processo]) {
        procEl.innerHTML += ` <a href="${driveLinksPorProcesso[d.processo]}" target="_blank">📁 Ver pasta</a>`;
      }
      document.getElementById("det-descricao-text").textContent = d.descricao;  
      document.getElementById("det-data-inicial-text").textContent = new Date(d.data_inicial).toISOString().split("T")[0];
      document.getElementById("det-prazo-text").textContent = new Date(d.prazo).toISOString().split("T")[0];
      document.getElementById("det-status").value = d.status||"pendente";
      originalValues["det-status"] = d.status||"pendente";
      document.getElementById("det-comentarios-text").textContent = d.comentarios||"";
      document.getElementById("det-comentarios").value = d.comentarios||"";
      originalValues["det-comentarios"] = d.comentarios||"";
      carregarAndamentos(d.andamentos||[]);
      carregarPartes(d.partes||[]);
    }

    function carregarPartes(partes) {
      detPartesList.innerHTML="";
      partes.forEach((parte, idx)=>{
        const li=document.createElement("li");
        let display="";
        if (parte.status==="falecido"||parte.status==="morto") {
          display=`<span style="color:red">${parte.nome}</span>`;
        } else {
          display=`<span style="color:blue">${parte.nome}</span>`;
        }
        // flags atuais
        const contatoFlag = parte.contato==="sim"?"🗣️":"📞";
        const assinouFlag = parte.assinou==="sim"?"✍️":"📄";
        li.innerHTML = display+ " "+contatoFlag+" "+assinouFlag;
        // herdeiros (só falecimento)
        if ((parte.status==="falecido"||parte.status==="morto")&&Array.isArray(parte.herdeiros)){
          const ul=document.createElement("ul"); ul.className="herdeiros-list";
          parte.herdeiros.forEach(h=>{
            const lih=document.createElement("li");
            const f1=h.assinou==="sim"?"✍️":"📄";
            const f2=h.contato==="sim"?"🗣️":"📞";
            lih.innerHTML=`${h.nome} ${f1} ${f2}`;
            ul.appendChild(lih);
          });
          li.appendChild(ul);
        }
        li.addEventListener("click",()=>abrirModalParte(parte,idx));
        detPartesList.appendChild(li);
      });
    }

    function abrirModalParte(parte, index) {
      parteDetailsContainer.innerHTML="";
      const title=document.createElement("h3");
      title.textContent="Detalhes da Parte – "+parte.nome;
      parteDetailsContainer.appendChild(title);

      // Status
      const statusLabel=document.createElement("label");
      statusLabel.textContent="Status: ";
      const statusSelect=document.createElement("select");
      statusSelect.className="parte-status";
      ["vivo","falecido"].forEach(v=>{
        const opt=document.createElement("option");
        opt.value=v; opt.textContent=v.charAt(0).toUpperCase()+v.slice(1);
        if(parte.status===v) opt.selected=true;
        statusSelect.appendChild(opt);
      });
      statusLabel.appendChild(statusSelect);
      parteDetailsContainer.appendChild(statusLabel);

      // LP?
      const lpLabel=document.createElement("label");
      lpLabel.textContent="LP? ";
      const lpSelect=document.createElement("select");
      lpSelect.className="parte-lp";
      ["sim","não"].forEach(v=>{
        const opt=document.createElement("option");
        opt.value=v; opt.textContent=v.charAt(0).toUpperCase()+v.slice(1);
        if(parte.lp===v) opt.selected=true;
        lpSelect.appendChild(opt);
      });
      lpLabel.appendChild(lpSelect);
      parteDetailsContainer.appendChild(lpLabel);

      // Interesse (vivo)
      const intrLabel=document.createElement("label");
      intrLabel.textContent="Interesse no acordo? ";
      const intrSelect=document.createElement("select");
      intrSelect.className="parte-interesse";
      ["sim","não"].forEach(v=>{
        const opt=document.createElement("option"); opt.value=v; opt.textContent=v.charAt(0).toUpperCase()+v.slice(1);
        if(parte.interesse===v) opt.selected=true;
        intrSelect.appendChild(opt);
      });
      intrLabel.appendChild(intrSelect);
      parteDetailsContainer.appendChild(intrLabel);

      // Nº de herdeiros (falecido)
      const nhLabel=document.createElement("label");
      nhLabel.textContent="Nº de herdeiros: ";
      const nhInput=document.createElement("input");
      nhInput.type="number"; nhInput.max=99; nhInput.className="num-herdeiros";
      nhInput.value=parte.numHerdeiros||0;
      nhLabel.appendChild(nhInput);
      parteDetailsContainer.appendChild(nhLabel);

      // Container LP fields
      const lpFields=document.createElement("div"); lpFields.id="lp-fields";
      ["Processo","Advogado","Observações"].forEach((lbl, i)=>{
        const label=document.createElement("label");
        label.textContent=lbl+": ";
        let inp;
        if(i<2){
          inp=document.createElement("input"); inp.type="text";
          inp.className=i===0?"lp-processo":"lp-advogado";
          inp.value=i===0?(parte.lpProcesso||""):(parte.lpAdvogado||"");
        } else {
          inp=document.createElement("textarea"); inp.rows=3; inp.className="lp-observacoes";
          inp.value=parte.lpObservacoes||"";
        }
        label.appendChild(inp);
        lpFields.appendChild(label);
      });
      parteDetailsContainer.appendChild(lpFields);

      // Container additional
      const addC=document.createElement("div"); addC.id="additional-fields";
      parteDetailsContainer.appendChild(addC);

      function render() {
        lpFields.style.display="none";
        addC.style.display="none";
        intrLabel.style.display="none";
        nhLabel.style.display="none";
        title.style.color="";
        if(lpSelect.value==="sim") {
          lpFields.style.display="block"; return;
        }
        if(statusSelect.value==="falecido") {
          nhLabel.style.display="block";
          addC.innerHTML="";
          parte.herdeiros.forEach(h=>{
            const r=document.createElement("div"); r.className="herdeiro-row";
            const span=document.createElement("span"); span.textContent=h.nome;
            const c1=document.createElement("input"); c1.type="checkbox"; c1.checked=h.assinou==="sim";
            const l1=document.createElement("label"); l1.textContent="Assinou?"; l1.prepend(c1);
            const c2=document.createElement("input"); c2.type="checkbox"; c2.checked=h.contato==="sim";
            const l2=document.createElement("label"); l2.textContent="Contato?"; l2.prepend(c2);
            r.append(span,l1,l2); addC.appendChild(r);
          });
          addC.style.display="block"; return;
        }
        if(statusSelect.value==="vivo") {
          intrLabel.style.display="block";
          if(intrSelect.value==="não") { title.style.color="#555"; return; }
          addC.innerHTML=`
            <label>Telefone: <input type="text" class="parte-telefone" value="${parte.telefone||""}"/></label>
            <label>Email: <input type="text" class="parte-email" value="${parte.email||""}"/></label>
            <label>Contato:
              <select class="parte-contato">
                <option value="sim"${parte.contato==="sim"?" selected":""}>Sim</option>
                <option value="não"${parte.contato==="não"?" selected":""}>Não</option>
              </select>
            </label>
            <label>Assinou Acordo:
              <select class="parte-assinou">
                <option value="sim"${parte.assinou==="sim"?" selected":""}>Sim</option>
                <option value="não"${parte.assinou==="não"?" selected":""}>Não</option>
              </select>
            </label>`;
          addC.style.display="block";
        }
      }

      [statusSelect,lpSelect,intrSelect].forEach(el=>el.addEventListener("change",render));
      render();

      const saveBtn=document.createElement("button");
      saveBtn.textContent="Salvar Parte"; saveBtn.className="parte-salvar";
      parteDetailsContainer.appendChild(saveBtn);
      saveBtn.addEventListener("click",async()=>{
        const up={ status: statusSelect.value, lp: lpSelect.value, interesse: intrSelect.value,
                   numHerdeiros: parseInt(nhInput.value)||0,
                   lpProcesso: lpFields.querySelector(".lp-processo").value,
                   lpAdvogado: lpFields.querySelector(".lp-advogado").value,
                   lpObservacoes: lpFields.querySelector(".lp-observacoes").value };
        if(statusSelect.value==="vivo"&&intrSelect.value==="sim") {
          up.telefone=addC.querySelector(".parte-telefone").value;
          up.email=addC.querySelector(".parte-email").value;
          up.contato=addC.querySelector(".parte-contato").value;
          up.assinou=addC.querySelector(".parte-assinou").value;
          up.herdeiros=[];
        }
        if(statusSelect.value==="falecido") {
          up.herdeiros=Array.from(addC.querySelectorAll(".herdeiro-row")).map(r=>({
            nome:r.querySelector("span").textContent,
            assinou:r.querySelector("input[type=checkbox]:nth-of-type(1)").checked?"sim":"não",
            contato:r.querySelector("input[type=checkbox]:nth-of-type(2)").checked?"sim":"não"
          }));
        }
        const docRef=db.collection("pendencias").doc(currentDocId);
        const parts=(await docRef.get()).data().partes||[];
        parts[index]=up;
        await docRef.update({ partes:parts });
        modal.classList.add("hidden");
        carregarDetalhes(currentDocId);
      });

      modal.classList.remove("hidden");
    }

    document.querySelectorAll(".editar").forEach(b=>{
      b.addEventListener("click",()=>{
        const id=b.dataset.alvo;
        const span=document.getElementById(id+"-text");
        const inp=document.getElementById(id);
        if(inp.classList.contains("hidden")) {
          inp.classList.remove("hidden"); span.classList.add("hidden");
        } else {
          inp.classList.add("hidden"); span.classList.remove("hidden");
          inp.value=originalValues[id];
        }
      });
    });

    salvarBtn.addEventListener("click",async()=>{
      const d={ status:document.getElementById("det-status").value,
                comentarios:document.getElementById("det-comentarios").value };
      await db.collection("pendencias").doc(currentDocId).update(d);
      salvarMsg.textContent="Atualizado com sucesso!";
      carregarPendencias(); carregarDetalhes(currentDocId);
    });

    enviarAndamento.addEventListener("click",async()=>{
      if(!novoAndamento.value.trim()) return;
      const texto=novoAndamento.value.trim();
      const autor=nomesPorEmail[auth.currentUser.email]||auth.currentUser.email;
      const now=new Date().toISOString();
      const docRef=db.collection("pendencias").doc(currentDocId);
      const arr=(await docRef.get()).data().andamentos||[];
      arr.push({ texto, autor, data:now });
      await docRef.update({ andamentos:arr });
      novoAndamento.value="";
      carregarDetalhes(currentDocId);
    });

    modalClose.addEventListener("click",()=>modal.classList.add("hidden"));
    window.addEventListener("click",e=>{ if(e.target===modal) modal.classList.add("hidden"); });
  </script>
</body>
</html>
